<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙调试 - FastAPI 后端工程</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">FastAPI 后端工程</h1>
            <nav class="nav">
                <ul>
                    <li><a href="/">首页</a></li>
                    <li><a href="/dashboard">仪表盘</a></li>
                    <li><a href="/bluetooth">蓝牙调试</a></li>
                    <li><a href="/api/v1/cloud">云盘</a></li>
                    <li>欢迎, {{ username }}</li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main">
        <section class="bluetooth">
            <div class="container">
                <h2>蓝牙调试工具</h2>
                <p>在此页面可以调试蓝牙(BT)和低功耗蓝牙(BLE)设备</p>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <h3>已连接设备</h3>
                        <p class="stat-value" id="connected-devices">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>BLE设备</h3>
                        <p class="stat-value" id="ble-devices">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>BT设备</h3>
                        <p class="stat-value" id="bt-devices">0</p>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <div class="content-card">
                        <h3>蓝牙设备扫描</h3>
                        <div class="bluetooth-controls">
                            <button id="scan-ble" class="btn btn-primary">扫描BLE设备</button>
                            <button id="scan-bt" class="btn btn-primary">扫描BT设备</button>
                            <button id="stop-scan" class="btn">停止扫描</button>
                        </div>
                        
                        <div class="device-list">
                            <h4>发现的设备</h4>
                            <div id="devices-container">
                                <p class="no-devices">暂无设备，请点击扫描按钮开始扫描</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <h3>连接状态</h3>
                        <div class="connection-status">
                            <p><strong>蓝牙适配器状态:</strong> <span id="adapter-status">未初始化</span></p>
                            <p><strong>扫描状态:</strong> <span id="scan-status">空闲</span></p>
                            <p><strong>连接设备:</strong> <span id="connected-device">无</span></p>
                        </div>
                        
                        <div class="protocol-data-section">
                            <h4>协议数据</h4>
                            <textarea id="protocol-data" class="protocol-data" placeholder="设备协议数据将显示在这里..."></textarea>
                            <div class="protocol-actions">
                                <button id="clear-data" class="btn">清空数据</button>
                                <button id="send-custom-data" class="btn btn-primary">发送自定义数据</button>
                            </div>
                        </div>
                        
                        <div class="bluetooth-actions">
                            <h4>调试操作</h4>
                            <button id="connect-device" class="btn" disabled>连接设备</button>
                            <button id="disconnect-device" class="btn" disabled>断开连接</button>
                            <button id="send-data" class="btn" disabled>发送数据</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2023 FastAPI 后端工程. 保留所有权利。</p>
        </div>
    </footer>
    
    <script>
        // 蓝牙调试功能
        document.addEventListener('DOMContentLoaded', function() {
            const scanBleBtn = document.getElementById('scan-ble');
            const scanBtBtn = document.getElementById('scan-bt');
            const stopScanBtn = document.getElementById('stop-scan');
            const connectBtn = document.getElementById('connect-device');
            const disconnectBtn = document.getElementById('disconnect-device');
            const sendDataBtn = document.getElementById('send-data');
            const devicesContainer = document.getElementById('devices-container');
            const adapterStatus = document.getElementById('adapter-status');
            const scanStatus = document.getElementById('scan-status');
            const connectedDevice = document.getElementById('connected-device');
            const protocolData = document.getElementById('protocol-data');
            const clearDataBtn = document.getElementById('clear-data');
            const sendCustomDataBtn = document.getElementById('send-custom-data');
            
            let currentScanController = null;
            
            // 扫描BLE设备
            scanBleBtn.addEventListener('click', async function() {
                try {
                    // 取消之前的扫描（如果有的话）
                    if (currentScanController) {
                        currentScanController.abort();
                    }
                    
                    adapterStatus.textContent = '已启用';
                    scanStatus.textContent = '扫描BLE设备中...';
                    devicesContainer.innerHTML = '<p class="no-devices">正在扫描...</p>';
                    
                    // 创建新的AbortController用于取消请求
                    currentScanController = new AbortController();
                    
                    const response = await fetch('/api/v1/bluetooth/scan/ble', {
                        signal: currentScanController.signal
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const devices = await response.json();
                    displayDevices(devices);
                    document.getElementById('ble-devices').textContent = devices.length;
                    scanStatus.textContent = '扫描完成';
                } catch (error) {
                    if (error.name === 'AbortError') {
                        scanStatus.textContent = '扫描已取消';
                    } else {
                        console.error('扫描BLE设备时出错:', error);
                        scanStatus.textContent = '扫描失败: ' + error.message;
                        devicesContainer.innerHTML = '<p class="no-devices">扫描失败，请重试</p>';
                    }
                }
            });
            
            // 扫描BT设备
            scanBtBtn.addEventListener('click', async function() {
                try {
                    // 取消之前的扫描（如果有的话）
                    if (currentScanController) {
                        currentScanController.abort();
                    }
                    
                    adapterStatus.textContent = '已启用';
                    scanStatus.textContent = '扫描BT设备中...';
                    devicesContainer.innerHTML = '<p class="no-devices">正在扫描...</p>';
                    
                    // 创建新的AbortController用于取消请求
                    currentScanController = new AbortController();
                    
                    const response = await fetch('/api/v1/bluetooth/scan/bt', {
                        signal: currentScanController.signal
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const devices = await response.json();
                    displayDevices(devices);
                    document.getElementById('bt-devices').textContent = devices.length;
                    scanStatus.textContent = '扫描完成';
                } catch (error) {
                    if (error.name === 'AbortError') {
                        scanStatus.textContent = '扫描已取消';
                    } else {
                        console.error('扫描BT设备时出错:', error);
                        scanStatus.textContent = '扫描失败: ' + error.message;
                        devicesContainer.innerHTML = '<p class="no-devices">扫描失败，请重试</p>';
                    }
                }
            });
            
            // 停止扫描
            stopScanBtn.addEventListener('click', function() {
                if (currentScanController) {
                    currentScanController.abort();
                    scanStatus.textContent = '已停止';
                }
            });
            
            // 清空协议数据
            clearDataBtn.addEventListener('click', function() {
                protocolData.value = '';
            });
            
            // 发送自定义数据
            sendCustomDataBtn.addEventListener('click', async function() {
                const customData = prompt('请输入要发送的数据:');
                if (customData !== null && customData.trim() !== '') {
                    const deviceId = connectedDevice.getAttribute('data-id');
                    if (!deviceId) {
                        alert('请先连接设备');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/v1/bluetooth/send_data/${deviceId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ message: customData })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        protocolData.value += `[发送] ${new Date().toLocaleTimeString()}: ${customData}\n`;
                        protocolData.value += `[响应] ${result.message}\n`;
                        protocolData.scrollTop = protocolData.scrollHeight;
                    } catch (error) {
                        console.error('发送数据时出错:', error);
                        alert('发送数据失败: ' + error.message);
                    }
                }
            });
            
            // 显示设备列表，包含MAC地址
            function displayDevices(devices) {
                if (devices.length === 0) {
                    devicesContainer.innerHTML = '<p class="no-devices">未找到设备</p>';
                    return;
                }
                
                let html = '<div class="device-items">';
                devices.forEach(device => {
                    html += `
                        <div class="device-item" data-id="${device.id}">
                            <div class="device-info">
                                <strong>${device.name}</strong>
                                <div>MAC地址: ${device.mac}</div>
                                <div>信号强度: ${device.rssi} dBm</div>
                                <div>类型: ${device.type}</div>
                            </div>
                            <button class="btn connect-btn" onclick="selectDevice('${device.id}', '${device.name}', '${device.mac}', '${device.type}')">选择</button>
                        </div>
                    `;
                });
                html += '</div>';
                devicesContainer.innerHTML = html;
            }
            
            // 选择设备
            window.selectDevice = function(id, name, mac, type) {
                connectBtn.disabled = false;
                connectedDevice.textContent = `${name} (${mac})`;
                connectedDevice.setAttribute('data-id', id);
                connectedDevice.setAttribute('data-type', type);
                
                // 显示设备信息到协议数据框
                protocolData.value = `设备已选中\n设备名称: ${name}\nMAC地址: ${mac}\n协议类型: ${type}\n选中时间: ${new Date().toLocaleString()}\n--------------------\n`;
            };
            
            // 连接设备
            connectBtn.addEventListener('click', async function() {
                const deviceId = connectedDevice.getAttribute('data-id');
                if (!deviceId) {
                    alert('请先选择设备');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/v1/bluetooth/connect/${deviceId}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    disconnectBtn.disabled = false;
                    connectBtn.disabled = true;
                    sendDataBtn.disabled = false;
                    
                    const currentConnected = parseInt(document.getElementById('connected-devices').textContent);
                    document.getElementById('connected-devices').textContent = currentConnected + 1;
                    
                    // 添加连接信息到协议数据框
                    protocolData.value += `[系统] ${result.message}\n`;
                    protocolData.scrollTop = protocolData.scrollHeight;
                } catch (error) {
                    console.error('连接设备时出错:', error);
                    alert('连接设备失败: ' + error.message);
                }
            });
            
            // 断开连接
            disconnectBtn.addEventListener('click', async function() {
                const deviceId = connectedDevice.getAttribute('data-id');
                if (!deviceId) {
                    alert('没有设备连接');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/v1/bluetooth/disconnect/${deviceId}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    disconnectBtn.disabled = true;
                    connectBtn.disabled = false;
                    sendDataBtn.disabled = true;
                    
                    const currentConnected = parseInt(document.getElementById('connected-devices').textContent);
                    document.getElementById('connected-devices').textContent = Math.max(0, currentConnected - 1);
                    
                    protocolData.value += `[系统] ${result.message}\n--------------------\n`;
                    protocolData.scrollTop = protocolData.scrollHeight;
                } catch (error) {
                    console.error('断开设备连接时出错:', error);
                    alert('断开设备连接失败: ' + error.message);
                }
            });
            
            // 发送数据
            sendDataBtn.addEventListener('click', async function() {
                const deviceId = connectedDevice.getAttribute('data-id');
                const deviceName = connectedDevice.textContent.split(' (')[0];
                
                if (!deviceId) {
                    alert('请先连接设备');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/v1/bluetooth/send_data/${deviceId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message: "测试数据" })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    protocolData.value += `[发送] ${new Date().toLocaleTimeString()}: 向设备 ${deviceName} 发送测试数据\n`;
                    protocolData.value += `[响应] ${result.message}\n`;
                    protocolData.scrollTop = protocolData.scrollHeight;
                } catch (error) {
                    console.error('发送数据时出错:', error);
                    alert('发送数据失败: ' + error.message);
                }
            });
        });
    </script>
    
    <style>
        .bluetooth-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .bluetooth-controls .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .device-list {
            margin-top: 20px;
        }
        
        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .device-info {
            flex-grow: 1;
        }
        
        .bluetooth-actions {
            margin-top: 20px;
        }
        
        .bluetooth-actions .btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .connection-status p {
            margin-bottom: 10px;
        }
        
        .no-devices {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .protocol-data-section {
            margin: 20px 0;
        }
        
        .protocol-data {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            background-color: #f8f8f8;
        }
        
        .protocol-actions {
            margin-top: 10px;
        }
        
        .protocol-actions .btn {
            margin-right: 10px;
        }
    </style>
</body>
</html>