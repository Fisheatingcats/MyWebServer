<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡æ§åˆ¶å° - IOT äº‘æ§ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* å…¨å±€æ ·å¼è°ƒæ•´ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        /* ä¸»å®¹å™¨å¸ƒå±€ */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* å·¦ä¾§èœå•æ  */
        .sidebar {
            width: 260px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h2 {
            font-size: 1.4rem;
            margin: 0;
            color: #ecf0f1;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
        }
        
        .sidebar-nav ul {
            list-style: none;
        }
        
        .sidebar-nav li {
            margin-bottom: 5px;
        }
        
        .sidebar-nav a {
            display: block;
            padding: 12px 20px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .sidebar-nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ecf0f1;
        }
        
        .sidebar-nav a.active {
            background-color: #1a73e8;
            color: white;
            border-left-color: #1976d2;
        }
        
        .sidebar-nav .icon {
            margin-right: 10px;
            display: inline-block;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: #95a5a6;
            font-size: 0.9rem;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .header {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .nav ul {
            display: flex;
            list-style: none;
            gap: 15px;
        }
        
        .nav a {
            text-decoration: none;
            color: #555;
            padding: 8px 15px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .nav a:hover {
            background-color: #f8f9fa;
            color: #1a73e8;
        }
        
        .nav a.active {
            background-color: #1a73e8;
            color: white;
        }
        
        /* å†…å®¹åŒºåŸŸ */
        .content {
            flex: 1;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .console-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin: 0;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1557b0;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        /* è®¾å¤‡ç½‘æ ¼ */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        /* è®¾å¤‡å¡ç‰‡ç¾åŒ– */
        .device-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-top: 4px solid #1a73e8;
        }
        
        .device-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .device-card.online {
            border-top-color: #4caf50;
        }
        
        .device-card.offline {
            border-top-color: #f44336;
            opacity: 0.8;
        }
        
        .device-info h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .device-status {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
            position: relative;
        }
        
        .status-indicator::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                transform: scale(1.2);
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        .status-online {
            background-color: #4caf50;
        }
        
        .status-online::after {
            background-color: #4caf50;
        }
        
        .status-offline {
            background-color: #f44336;
            animation: none;
        }
        
        .status-offline::after {
            display: none;
        }
        
        .device-details {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        
        .detail-item:last-child {
            margin-bottom: 0;
        }
        
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        
        .detail-value {
            font-weight: 600;
            color: #333;
        }
        
        .device-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* æ§åˆ¶æŒ‰é’®æ ·å¼ç¾åŒ– */
        .btn-control {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-control:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-control:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-on {
            background-color: #4caf50;
            color: white;
        }
        
        .btn-on:hover:not(:disabled) {
            background-color: #3d8b40;
        }
        
        .btn-off {
            background-color: #f44336;
            color: white;
        }
        
        .btn-warning {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background-color: #f57c00;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background-color: #d32f2f;
        }
        
        /* OTAå›ºä»¶ä¸Šä¼ åŒºåŸŸ */
        .ota-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-top: 30px;
        }
        
        .ota-section h2 {
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .ota-form {
            max-width: 700px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }
        
        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background-color: #fff;
        }
        
        .form-group input[type="text"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .ota-options {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 15px 0;
        }
        
        .ota-options label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            transition: color 0.3s ease;
        }
        
        .ota-options label:hover {
            color: #1a73e8;
        }
        
        .ota-options input[type="radio"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: #1a73e8;
        }
        
        .btn-ota {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-ota:hover {
            background-color: #1976d2;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        /* æ–°å»ºè®¾å¤‡æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlide 0.3s ease-out;
        }
        
        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-header h3 {
            color: #2c3e50;
            font-size: 1.4rem;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background-color: #f8f9fa;
            color: #333;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        /* çŠ¶æ€ç»Ÿè®¡å¡ç‰‡ */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
        }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #1a73e8;
        }
        
        .stat-card p {
            color: #666;
            font-size: 0.95rem;
            margin: 0;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                transform: translateX(-100%);
                position: fixed;
                z-index: 1000;
                height: 100vh;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .console-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .device-grid {
                grid-template-columns: 1fr;
            }
            
            .device-actions {
                flex-direction: column;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å·¦ä¾§èœå•æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>è®¾å¤‡ç®¡ç†</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="#" class="active" onclick="showSection('current-devices')">
                            <span class="icon">ğŸ“±</span> å½“å‰è®¾å¤‡
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('add-device')">
                            <span class="icon">â•</span> æ–°å»ºè®¾å¤‡
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('ota-management')">
                            <span class="icon">ğŸ”„</span> OTAç®¡ç†
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showAddDeviceTypeModal()">
                            <span class="icon">ğŸ·ï¸</span> ç®¡ç†è®¾å¤‡ç±»å‹
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('device-stats')">
                            <span class="icon">ğŸ“Š</span> è®¾å¤‡ç»Ÿè®¡
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <p>Â© 2024 IOT äº‘æ§ç³»ç»Ÿ</p>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <header class="header">
                <h1 class="logo">IOT äº‘æ§ç³»ç»Ÿ</h1>
                <nav class="nav">
                    <ul>
                        <li><a href="/">é¦–é¡µ</a></li>
                        <li><a href="/bluetooth">è“ç‰™è°ƒè¯•</a></li>
                        <li><a href="/api/v1/cloud">äº‘ç›˜</a></li>
                        <li><a href="/device_console" class="active">è®¾å¤‡æ§åˆ¶å°</a></li>
                    </ul>
                </nav>
            </header>

            <div class="content">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <section id="device-stats" class="section">
                    <div class="stats-cards">
                        <div class="stat-card">
                            <h3>3</h3>
                            <p>æ€»è®¾å¤‡æ•°</p>
                        </div>
                        <div class="stat-card">
                            <h3>2</h3>
                            <p>åœ¨çº¿è®¾å¤‡</p>
                        </div>
                        <div class="stat-card">
                            <h3>1</h3>
                            <p>ç¦»çº¿è®¾å¤‡</p>
                        </div>
                        <div class="stat-card">
                            <h3>67%</h3>
                            <p>è®¾å¤‡åœ¨çº¿ç‡</p>
                        </div>
                    </div>
                </section>

                <!-- å½“å‰è®¾å¤‡åˆ—è¡¨ -->
                <section id="current-devices" class="section">
                    <div class="console-header">
                        <h2>è®¾å¤‡åˆ—è¡¨</h2>
                        <div>
                            <button class="btn btn-primary" onclick="showAddDeviceModal()">
                                <span class="icon">â•</span> æ–°å»ºè®¾å¤‡
                            </button>
                            <button class="btn btn-secondary" onclick="refreshDeviceList()" style="margin-left: 10px;">
                                <span class="icon">ğŸ”„</span> åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    
                    <!-- è®¾å¤‡ç±»å‹åˆ†ç»„ - æ™ºèƒ½ç½‘å…³ -->
                    <div class="device-type-group">
                        <div class="device-type-header" onclick="toggleDeviceTypeGroup('gateway')">
                            <h3>
                                <span class="icon">ğŸ </span> æ™ºèƒ½ç½‘å…³
                            </h3>
                            <div class="type-stats">
                                <span>åœ¨çº¿: 1</span> | <span>æ€»æ•°: 1</span>
                                <span class="expand-icon">â–¼</span>
                            </div>
                        </div>
                        <div class="device-type-content" id="gateway-group">
                            <!-- è®¾å¤‡å¡ç‰‡ -->
                            <div class="device-card">
                                <div class="device-header">
                                    <h3>æ™ºèƒ½ç½‘å…³ 001</h3>
                                    <span class="status-indicator online"></span>
                                </div>
                                <div class="device-info">
                                    <p><strong>è®¾å¤‡ID:</strong> DEV-2024-0001</p>
                                    <p><strong>ä½ç½®:</strong> ä¸»æ§å®¤</p>
                                    <p><strong>æœ€ååœ¨çº¿:</strong> åˆšåˆš</p>
                                    <p><strong>å›ºä»¶ç‰ˆæœ¬:</strong> V1.2.3</p>
                                </div>
                                <div class="device-actions">
                                    <button class="btn-control btn-view" onclick="viewDeviceDetails('DEV-2024-0001')">æŸ¥çœ‹</button>
                                    <button class="btn-control btn-edit" onclick="editDevice('DEV-2024-0001')">ç¼–è¾‘</button>
                                    <button class="btn-control btn-restart" onclick="controlDevice('DEV-2024-0001', 'restart')">é‡å¯</button>
                                    <button class="btn-control btn-ota" onclick="showOtaOptions('DEV-2024-0001')">OTA</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è®¾å¤‡ç±»å‹åˆ†ç»„ - ä¼ æ„Ÿå™¨èŠ‚ç‚¹ -->
                    <div class="device-type-group">
                        <div class="device-type-header" onclick="toggleDeviceTypeGroup('sensor')">
                            <h3>
                                <span class="icon">ğŸ“Š</span> ä¼ æ„Ÿå™¨èŠ‚ç‚¹
                            </h3>
                            <div class="type-stats">
                                <span>åœ¨çº¿: 1</span> | <span>æ€»æ•°: 1</span>
                                <span class="expand-icon">â–¼</span>
                            </div>
                        </div>
                        <div class="device-type-content" id="sensor-group">
                            <!-- è®¾å¤‡å¡ç‰‡ -->
                            <div class="device-card">
                                <div class="device-header">
                                    <h3>ä¼ æ„Ÿå™¨èŠ‚ç‚¹ 002</h3>
                                    <span class="status-indicator online"></span>
                                </div>
                                <div class="device-info">
                                    <p><strong>è®¾å¤‡ID:</strong> DEV-2024-0002</p>
                                    <p><strong>ä½ç½®:</strong> ä¸€æ¥¼å¤§å…</p>
                                    <p><strong>æœ€ååœ¨çº¿:</strong> 5åˆ†é’Ÿå‰</p>
                                    <p><strong>å›ºä»¶ç‰ˆæœ¬:</strong> V1.1.0</p>
                                </div>
                                <div class="device-actions">
                                    <button class="btn-control btn-view" onclick="viewDeviceDetails('DEV-2024-0002')">æŸ¥çœ‹</button>
                                    <button class="btn-control btn-edit" onclick="editDevice('DEV-2024-0002')">ç¼–è¾‘</button>
                                    <button class="btn-control btn-restart" onclick="controlDevice('DEV-2024-0002', 'restart')">é‡å¯</button>
                                    <button class="btn-control btn-ota" onclick="showOtaOptions('DEV-2024-0002')">OTA</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è®¾å¤‡ç±»å‹åˆ†ç»„ - æ§åˆ¶å™¨èŠ‚ç‚¹ -->
                    <div class="device-type-group">
                        <div class="device-type-header" onclick="toggleDeviceTypeGroup('controller')">
                            <h3>
                                <span class="icon">âš™ï¸</span> æ§åˆ¶å™¨èŠ‚ç‚¹
                            </h3>
                            <div class="type-stats">
                                <span>åœ¨çº¿: 0</span> | <span>æ€»æ•°: 1</span>
                                <span class="expand-icon">â–¼</span>
                            </div>
                        </div>
                        <div class="device-type-content" id="controller-group">
                            <!-- è®¾å¤‡å¡ç‰‡ -->
                            <div class="device-card">
                                <div class="device-header">
                                    <h3>æ§åˆ¶å™¨èŠ‚ç‚¹ 003</h3>
                                    <span class="status-indicator offline"></span>
                                </div>
                                <div class="device-info">
                                    <p><strong>è®¾å¤‡ID:</strong> DEV-2024-0003</p>
                                    <p><strong>ä½ç½®:</strong> äºŒæ¥¼ä¼šè®®å®¤</p>
                                    <p><strong>æœ€ååœ¨çº¿:</strong> 2å°æ—¶å‰</p>
                                    <p><strong>å›ºä»¶ç‰ˆæœ¬:</strong> V1.0.5</p>
                                </div>
                                <div class="device-actions">
                                    <button class="btn-control btn-view" onclick="viewDeviceDetails('DEV-2024-0003')">æŸ¥çœ‹</button>
                                    <button class="btn-control btn-edit" onclick="editDevice('DEV-2024-0003')">ç¼–è¾‘</button>
                                    <button class="btn-control btn-restart" onclick="controlDevice('DEV-2024-0003', 'restart')">é‡å¯</button>
                                    <button class="btn-control btn-ota" onclick="showOtaOptions('DEV-2024-0003')">OTA</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- OTAå›ºä»¶ä¸Šä¼ åŒºåŸŸ -->
                <section id="ota-management" class="section">
                    <div class="console-header">
                        <h2>OTAå›ºä»¶ç®¡ç†</h2>
                    </div>
                    
                    <div class="ota-section">
                        <form id="ota-form" class="ota-form" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="firmware-file">é€‰æ‹©å›ºä»¶æ–‡ä»¶:</label>
                                <input type="file" id="firmware-file" name="firmware_file" accept=".bin,.hex,.zip" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="firmware-version">å›ºä»¶ç‰ˆæœ¬:</label>
                                <input type="text" id="firmware-version" name="firmware_version" placeholder="ä¾‹å¦‚: V1.3.0" required>
                            </div>
                            
                            <div class="form-group">
                                <label>OTAæ›´æ–°é€‰é¡¹:</label>
                                <div class="ota-options">
                                    <label>
                                        <input type="radio" name="ota_type" value="notification" checked>
                                        å‘é€OTAæé†’ (è®¾å¤‡ç”¨æˆ·å¯é€‰æ‹©æ˜¯å¦æ›´æ–°)
                                    </label>
                                    <label>
                                        <input type="radio" name="ota_type" value="force">
                                        å¼ºåˆ¶OTAæ›´æ–° (è®¾å¤‡å°†è‡ªåŠ¨æ›´æ–°)
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="target-device">ç›®æ ‡è®¾å¤‡:</label>
                                <select id="target-device" name="target_device" required>
                                    <option value="all">æ‰€æœ‰åœ¨çº¿è®¾å¤‡</option>
                                    <option value="DEV-2024-0001">æ™ºèƒ½ç½‘å…³ 001</option>
                                    <option value="DEV-2024-0002">ä¼ æ„Ÿå™¨èŠ‚ç‚¹ 002</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="update-description">æ›´æ–°è¯´æ˜:</label>
                                <textarea id="update-description" name="update_description" rows="3" placeholder="æè¿°æœ¬æ¬¡æ›´æ–°çš„å†…å®¹å’Œæ”¹è¿›..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn-ota">
                                <span class="icon">ğŸ“¤</span> ä¸Šä¼ å¹¶æ‰§è¡ŒOTAæ›´æ–°
                            </button>
                        </form>
                    </div>
                </section>

                <!-- æ–°å»ºè®¾å¤‡æ¨¡æ€æ¡† -->
                <div id="add-device-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>æ–°å»ºè®¾å¤‡</h3>
                            <button class="modal-close" onclick="closeAddDeviceModal()">&times;</button>
                        </div>
                        <form id="add-device-form">
                            <div class="form-group">
                                <label for="device-name">è®¾å¤‡åç§°:</label>
                                <input type="text" id="device-name" name="device_name" placeholder="è¾“å…¥è®¾å¤‡åç§°" required>
                            </div>
                            <div class="form-group">
                                <label for="device-type">è®¾å¤‡ç±»å‹:</label>
                                <select id="device-type" name="device_type" required>
                                    <!-- è®¾å¤‡ç±»å‹é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                                </select>
                                <div style="margin-top: 5px; font-size: 0.9rem; color: #666;">
                                    æ²¡æœ‰åˆé€‚çš„è®¾å¤‡ç±»å‹ï¼Ÿ <a href="javascript:void(0)" onclick="showAddDeviceTypeModal()">åˆ›å»ºæ–°ç±»å‹</a>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="device-id">è®¾å¤‡ID (å¯é€‰):</label>
                                <input type="text" id="device-id" name="device_id" placeholder="å¦‚ä¸å¡«å†™å°†è‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label for="device-location">è®¾å¤‡ä½ç½®:</label>
                                <input type="text" id="device-location" name="device_location" placeholder="è¾“å…¥è®¾å¤‡ä½ç½®ä¿¡æ¯">
                            </div>
                            <div class="form-group">
                                <label for="device-description">è®¾å¤‡æè¿°:</label>
                                <textarea id="device-description" name="device_description" rows="3" placeholder="è¾“å…¥è®¾å¤‡è¯¦ç»†æè¿°"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="device-data">è®¾å¤‡ç§æœ‰æ•°æ® (JSONæ ¼å¼):</label>
                                <textarea id="device-data" name="device_data" rows="4" placeholder='ä¾‹å¦‚: {"sensors": [{"type": "temperature", "unit": "Â°C"}], "actuators": [{"type": "relay", "count": 4}]}'></textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeAddDeviceModal()">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">åˆ›å»ºè®¾å¤‡</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- è®¾å¤‡ç±»å‹ç®¡ç†æ¨¡æ€æ¡† -->
                <div id="add-device-type-modal" class="modal">
                    <div class="modal-content" style="width: 600px;">
                        <div class="modal-header">
                            <h3>è®¾å¤‡ç±»å‹ç®¡ç†</h3>
                            <button class="modal-close" onclick="closeAddDeviceTypeModal()">&times;</button>
                        </div>
                        
                        <div class="modal-tabs">
                            <button class="tab-btn active" onclick="showDeviceTypeTab('list')">ç±»å‹åˆ—è¡¨</button>
                            <button class="tab-btn" onclick="showDeviceTypeTab('create')">æ–°å»ºç±»å‹</button>
                        </div>
                        
                        <!-- è®¾å¤‡ç±»å‹åˆ—è¡¨ -->
                        <div id="device-type-list" class="tab-content active">
                            <div class="table-responsive">
                                <table class="device-type-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>åç§°</th>
                                            <th>å›¾æ ‡</th>
                                            <th>æè¿°</th>
                                            <th>è®¾å¤‡æ•°</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>1</td>
                                            <td>æ™ºèƒ½ç½‘å…³</td>
                                            <td>ğŸ </td>
                                            <td>ç½‘ç»œè¿æ¥å’Œæ•°æ®è½¬å‘è®¾å¤‡</td>
                                            <td>1</td>
                                            <td>
                                                <button class="btn-edit-small" onclick="editDeviceType(1)">ç¼–è¾‘</button>
                                                <button class="btn-delete-small" onclick="deleteDeviceType(1)">åˆ é™¤</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>2</td>
                                            <td>ä¼ æ„Ÿå™¨èŠ‚ç‚¹</td>
                                            <td>ğŸ“Š</td>
                                            <td>ç¯å¢ƒæ•°æ®é‡‡é›†è®¾å¤‡</td>
                                            <td>1</td>
                                            <td>
                                                <button class="btn-edit-small" onclick="editDeviceType(2)">ç¼–è¾‘</button>
                                                <button class="btn-delete-small" onclick="deleteDeviceType(2)">åˆ é™¤</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>3</td>
                                            <td>æ§åˆ¶å™¨èŠ‚ç‚¹</td>
                                            <td>âš™ï¸</td>
                                            <td>æ‰§è¡Œæ§åˆ¶å‘½ä»¤çš„è®¾å¤‡</td>
                                            <td>1</td>
                                            <td>
                                                <button class="btn-edit-small" onclick="editDeviceType(3)">ç¼–è¾‘</button>
                                                <button class="btn-delete-small" onclick="deleteDeviceType(3)">åˆ é™¤</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- åˆ›å»ºè®¾å¤‡ç±»å‹è¡¨å• -->
                        <div id="device-type-create" class="tab-content">
                            <form id="add-device-type-form">
                                <div class="form-group">
                                    <label for="type-name">ç±»å‹åç§°:</label>
                                    <input type="text" id="type-name" name="type_name" placeholder="è¾“å…¥è®¾å¤‡ç±»å‹åç§°" required>
                                </div>
                                <div class="form-group">
                                    <label for="type-icon">ç±»å‹å›¾æ ‡:</label>
                                    <input type="text" id="type-icon" name="type_icon" placeholder="è¾“å…¥emojiå›¾æ ‡" required>
                                    <div class="emoji-suggestions">
                                        <span onclick="setTypeIcon('ğŸ ')">ğŸ </span>
                                        <span onclick="setTypeIcon('ğŸ“Š')">ğŸ“Š</span>
                                        <span onclick="setTypeIcon('âš™ï¸')">âš™ï¸</span>
                                        <span onclick="setTypeIcon('ğŸ’¡')">ğŸ’¡</span>
                                        <span onclick="setTypeIcon('ğŸ”’')">ğŸ”’</span>
                                        <span onclick="setTypeIcon('ğŸ”‹')">ğŸ”‹</span>
                                        <span onclick="setTypeIcon('ğŸŒ¡ï¸')">ğŸŒ¡ï¸</span>
                                        <span onclick="setTypeIcon('ğŸ’§')">ğŸ’§</span>
                                        <span onclick="setTypeIcon('ğŸ’¨')">ğŸ’¨</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="type-description">ç±»å‹æè¿°:</label>
                                    <textarea id="type-description" name="type_description" rows="3" placeholder="è¾“å…¥è®¾å¤‡ç±»å‹æè¿°"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="type-properties">é»˜è®¤å±æ€§ (JSONæ ¼å¼):</label>
                                    <textarea id="type-properties" name="type_properties" rows="4" placeholder='ä¾‹å¦‚: {"capabilities": ["data_collection", "remote_control"], "data_fields": [{"name": "temperature", "type": "number"}]}'></textarea>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="showDeviceTypeTab('list')">å–æ¶ˆ</button>
                                    <button type="submit" class="btn btn-primary">åˆ›å»ºç±»å‹</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // é»˜è®¤æ˜¾ç¤ºå½“å‰è®¾å¤‡åˆ—è¡¨
            showSection('current-devices');
            
            // åˆå§‹åŒ–è®¾å¤‡ç±»å‹ä¸‹æ‹‰åˆ—è¡¨
            initDeviceTypeDropdown();
        });

        // åˆå§‹åŒ–è®¾å¤‡ç±»å‹ä¸‹æ‹‰åˆ—è¡¨
        function initDeviceTypeDropdown() {
            const deviceTypeSelect = document.getElementById('device-type');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            deviceTypeSelect.innerHTML = '';
            
            // æ·»åŠ é»˜è®¤é€‰é¡¹
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'è¯·é€‰æ‹©è®¾å¤‡ç±»å‹';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            deviceTypeSelect.appendChild(defaultOption);
            
            // æ·»åŠ è®¾å¤‡ç±»å‹é€‰é¡¹
            const deviceTypes = [
                { id: 'gateway', name: 'æ™ºèƒ½ç½‘å…³' },
                { id: 'sensor', name: 'ä¼ æ„Ÿå™¨èŠ‚ç‚¹' },
                { id: 'controller', name: 'æ§åˆ¶å™¨èŠ‚ç‚¹' }
            ];
            
            deviceTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                deviceTypeSelect.appendChild(option);
            });
        }

        // åˆ‡æ¢è®¾å¤‡ç±»å‹åˆ†ç»„æ˜¾ç¤º
        function toggleDeviceTypeGroup(groupId) {
            const groupContent = document.getElementById(`${groupId}-group`);
            const expandIcon = event.currentTarget.querySelector('.expand-icon');
            
            if (groupContent.style.display === 'none') {
                groupContent.style.display = 'grid';
                expandIcon.textContent = 'â–¼';
            } else {
                groupContent.style.display = 'none';
                expandIcon.textContent = 'â–¶';
            }
        }

        // æ˜¾ç¤ºè®¾å¤‡ç±»å‹ç®¡ç†æ¨¡æ€æ¡†
        function showAddDeviceTypeModal() {
            const modal = document.getElementById('add-device-type-modal');
            modal.classList.add('active');
            showDeviceTypeTab('list');
        }

        // æ˜¾ç¤ºæ–°å»ºè®¾å¤‡æ¨¡æ€æ¡†
        function showAddDeviceModal() {
            const modal = document.getElementById('add-device-modal');
            modal.classList.add('active');
            
            // åˆå§‹åŒ–è¡¨å•
            document.getElementById('add-device-form').reset();
        }
        
        // å…³é—­æ–°å»ºè®¾å¤‡æ¨¡æ€æ¡†
        function closeAddDeviceModal() {
            const modal = document.getElementById('add-device-modal');
            modal.classList.remove('active');
        }
        
        // å…³é—­è®¾å¤‡ç±»å‹ç®¡ç†æ¨¡æ€æ¡†
        function closeAddDeviceTypeModal() {
            const modal = document.getElementById('add-device-type-modal');
            modal.classList.remove('active');
            
            // é‡æ–°åˆå§‹åŒ–è®¾å¤‡ç±»å‹ä¸‹æ‹‰åˆ—è¡¨ï¼Œç¡®ä¿æ–°åˆ›å»ºçš„ç±»å‹æ˜¾ç¤º
            initDeviceTypeDropdown();
        }

        // æ˜¾ç¤ºè®¾å¤‡ç±»å‹æ ‡ç­¾é¡µ
        function showDeviceTypeTab(tabId) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(`device-type-${tabId}`).classList.add('active');
            
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // æ¿€æ´»å½“å‰æ ‡ç­¾æŒ‰é’®
            event.currentTarget.classList.add('active');
        }

        // è®¾ç½®ç±»å‹å›¾æ ‡
        function setTypeIcon(icon) {
            document.getElementById('type-icon').value = icon;
        }

        // æŸ¥çœ‹è®¾å¤‡è¯¦æƒ…
        function viewDeviceDetails(deviceId) {
            // å®é™…å®ç°æ—¶ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–è®¾å¤‡è¯¦æƒ…
            console.log(`æŸ¥çœ‹è®¾å¤‡ ${deviceId} è¯¦æƒ…`);
            showNotification(`å·²åŠ è½½è®¾å¤‡ ${deviceId} è¯¦æƒ…`, 'info');
        }

        // ç¼–è¾‘è®¾å¤‡
        function editDevice(deviceId) {
            // å®é™…å®ç°æ—¶ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–è®¾å¤‡ä¿¡æ¯å¹¶å¡«å……è¡¨å•
            console.log(`ç¼–è¾‘è®¾å¤‡ ${deviceId}`);
            showAddDeviceModal();
            document.getElementById('device-name').value = `è®¾å¤‡ ${deviceId}`;
            showNotification(`æ­£åœ¨ç¼–è¾‘è®¾å¤‡ ${deviceId}`, 'info');
        }

        // ç¼–è¾‘è®¾å¤‡ç±»å‹
        function editDeviceType(typeId) {
            // åˆ‡æ¢åˆ°åˆ›å»ºæ ‡ç­¾é¡µ
            showDeviceTypeTab('create');
            
            // å®é™…å®ç°æ—¶ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–è®¾å¤‡ç±»å‹ä¿¡æ¯å¹¶å¡«å……è¡¨å•
            console.log(`ç¼–è¾‘è®¾å¤‡ç±»å‹ ${typeId}`);
            
            // æ ¹æ®ç±»å‹IDè®¾ç½®è¡¨å•å€¼ç¤ºä¾‹
            if (typeId === 1) {
                document.getElementById('type-name').value = 'æ™ºèƒ½ç½‘å…³';
                document.getElementById('type-icon').value = 'ğŸ ';
                document.getElementById('type-description').value = 'ç½‘ç»œè¿æ¥å’Œæ•°æ®è½¬å‘è®¾å¤‡';
            } else if (typeId === 2) {
                document.getElementById('type-name').value = 'ä¼ æ„Ÿå™¨èŠ‚ç‚¹';
                document.getElementById('type-icon').value = 'ğŸ“Š';
                document.getElementById('type-description').value = 'ç¯å¢ƒæ•°æ®é‡‡é›†è®¾å¤‡';
            } else if (typeId === 3) {
                document.getElementById('type-name').value = 'æ§åˆ¶å™¨èŠ‚ç‚¹';
                document.getElementById('type-icon').value = 'âš™ï¸';
                document.getElementById('type-description').value = 'æ‰§è¡Œæ§åˆ¶å‘½ä»¤çš„è®¾å¤‡';
            }
            
            showNotification(`æ­£åœ¨ç¼–è¾‘è®¾å¤‡ç±»å‹ ${typeId}`, 'info');
        }

        // åˆ é™¤è®¾å¤‡ç±»å‹
        function deleteDeviceType(typeId) {
            // å®é™…å®ç°æ—¶ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIåˆ é™¤è®¾å¤‡ç±»å‹
            console.log(`åˆ é™¤è®¾å¤‡ç±»å‹ ${typeId}`);
            
            // æ˜¾ç¤ºç¡®è®¤æç¤º
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è®¾å¤‡ç±»å‹å—ï¼Ÿè¿™å°†å½±å“ä½¿ç”¨è¯¥ç±»å‹çš„æ‰€æœ‰è®¾å¤‡ã€‚')) {
                showNotification(`è®¾å¤‡ç±»å‹ ${typeId} å·²åˆ é™¤`, 'success');
                // è¿™é‡Œåº”è¯¥é‡æ–°åŠ è½½è®¾å¤‡ç±»å‹åˆ—è¡¨
            }
        }

        // æ–°å»ºè®¾å¤‡ç±»å‹è¡¨å•æäº¤å¤„ç†
        document.getElementById('add-device-type-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const typeName = document.getElementById('type-name').value;
            const typeIcon = document.getElementById('type-icon').value;
            const typeDescription = document.getElementById('type-description').value;
            const typeProperties = document.getElementById('type-properties').value;
            
            // è¡¨å•éªŒè¯
            if (!typeName) {
                showNotification('è¯·è¾“å…¥è®¾å¤‡ç±»å‹åç§°', 'error');
                return;
            }
            
            // è·å–æäº¤æŒ‰é’®å¹¶ä¿®æ”¹ä¸ºåŠ è½½çŠ¶æ€
            const submitButton = this.querySelector('button[type="submit"]');
            const originalContent = submitButton.innerHTML;
            submitButton.innerHTML = '<span class="loading"></span> åˆ›å»ºä¸­...';
            submitButton.disabled = true;
            
            try {
                // æ„å»ºç±»å‹æ•°æ®
                const typeData = {
                    name: typeName,
                    icon: typeIcon,
                    description: typeDescription,
                    properties: typeProperties ? JSON.parse(typeProperties) : {}
                };
                
                // è°ƒç”¨APIåˆ›å»ºæ–°è®¾å¤‡ç±»å‹
                const response = await fetch('/api/v1/device-type', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(typeData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `åˆ›å»ºè®¾å¤‡ç±»å‹å¤±è´¥! status: ${response.status}`);
                }
                
                const newDeviceType = await response.json();
                console.log('åˆ›å»ºæ–°è®¾å¤‡ç±»å‹æˆåŠŸ:', newDeviceType);
                
                // åˆ‡æ¢åˆ°ç±»å‹åˆ—è¡¨
                showDeviceTypeTab('list');
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification(`è®¾å¤‡ç±»å‹ "${typeName}" å·²æˆåŠŸåˆ›å»º`, 'success');
                
                // é‡ç½®è¡¨å•
                this.reset();
                
                // åˆ·æ–°è®¾å¤‡åˆ—è¡¨ï¼Œç¡®ä¿æ–°è®¾å¤‡ç±»å‹æ­£ç¡®æ˜¾ç¤º
                await refreshDeviceList();
                
            } catch (error) {
                console.error('åˆ›å»ºè®¾å¤‡ç±»å‹å¤±è´¥:', error);
                showNotification(error.message || 'åˆ›å»ºè®¾å¤‡ç±»å‹å¤±è´¥', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
            }
        });

        // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
        async function refreshDeviceList() {
            // æ·»åŠ åŠ è½½åŠ¨ç”»
            let refreshButton = null;
            if (event && event.currentTarget) {
                refreshButton = event.currentTarget;
                const originalContent = refreshButton.innerHTML;
                refreshButton.innerHTML = '<span class="loading"></span> åˆ·æ–°ä¸­...';
                refreshButton.disabled = true;
            }
            
            try {
                // è·å–è®¾å¤‡ç±»å‹åˆ—è¡¨
                const deviceTypesResponse = await fetch('/api/v1/device-type');
                if (!deviceTypesResponse.ok) {
                    throw new Error(`è·å–è®¾å¤‡ç±»å‹å¤±è´¥! status: ${deviceTypesResponse.status}`);
                }
                const deviceTypes = await deviceTypesResponse.json();
                
                // è·å–è®¾å¤‡åˆ—è¡¨
                const devicesResponse = await fetch('/api/v1/device');
                if (!devicesResponse.ok) {
                    throw new Error(`è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥! status: ${devicesResponse.status}`);
                }
                const devices = await devicesResponse.json();
                
                const deviceList = document.getElementById('device-list');
                deviceList.innerHTML = '';
                
                // æ›´æ–°è®¾å¤‡ç»Ÿè®¡
                updateDeviceStats(devices);
                
                // å¦‚æœæ²¡æœ‰è®¾å¤‡
                if (devices.length === 0) {
                    deviceList.innerHTML = '<p class="no-devices">æš‚æ— è®¾å¤‡</p>';
                    return;
                }
                
                // æŒ‰è®¾å¤‡ç±»å‹åˆ†ç»„è®¾å¤‡
                const devicesByType = {};
                devices.forEach(device => {
                    if (!devicesByType[device.device_type_id]) {
                        devicesByType[device.device_type_id] = [];
                    }
                    devicesByType[device.device_type_id].push(device);
                });
                
                // åˆ›å»ºè®¾å¤‡ç±»å‹åˆ†ç»„
                deviceTypes.forEach(deviceType => {
                    const devicesInType = devicesByType[deviceType.id] || [];
                    if (devicesInType.length > 0) {
                        // åˆ›å»ºè®¾å¤‡ç±»å‹åˆ†ç»„å®¹å™¨
                        const typeGroup = document.createElement('div');
                        typeGroup.className = 'device-type-group';
                        
                        // åˆ›å»ºè®¾å¤‡ç±»å‹æ ‡é¢˜
                        const typeHeader = document.createElement('div');
                        typeHeader.className = 'device-type-header';
                        typeHeader.innerHTML = `
                            <h3>${deviceType.name}</h3>
                            <span class="device-count">${devicesInType.length}å°è®¾å¤‡</span>
                        `;
                        
                        // åˆ›å»ºè®¾å¤‡ç±»å‹å†…å®¹åŒºåŸŸ
                        const typeContent = document.createElement('div');
                        typeContent.className = 'device-type-content';
                        
                        // åˆ›å»ºè®¾å¤‡ç½‘æ ¼
                        const deviceGrid = document.createElement('div');
                        deviceGrid.className = 'device-grid';
                        
                        // æ·»åŠ è®¾å¤‡å¡ç‰‡
                        devicesInType.forEach(device => {
                            const deviceCard = createDeviceCard(device);
                            deviceGrid.appendChild(deviceCard);
                        });
                        
                        // ç»„åˆå…ƒç´ 
                        typeContent.appendChild(deviceGrid);
                        typeGroup.appendChild(typeHeader);
                        typeGroup.appendChild(typeContent);
                        deviceList.appendChild(typeGroup);
                    }
                });
                
                // å¤„ç†æ²¡æœ‰ç±»å‹çš„è®¾å¤‡ï¼ˆå¦‚æœæœ‰ï¼‰
                const untypedDevices = devices.filter(device => !device.device_type_id);
                if (untypedDevices.length > 0) {
                    // åˆ›å»ºæœªåˆ†ç±»åˆ†ç»„å®¹å™¨
                    const untypedGroup = document.createElement('div');
                    untypedGroup.className = 'device-type-group';
                    
                    // åˆ›å»ºæœªåˆ†ç±»æ ‡é¢˜
                    const untypedHeader = document.createElement('div');
                    untypedHeader.className = 'device-type-header';
                    untypedHeader.innerHTML = `
                        <h3>æœªåˆ†ç±»è®¾å¤‡</h3>
                        <span class="device-count">${untypedDevices.length}å°è®¾å¤‡</span>
                    `;
                    
                    // åˆ›å»ºæœªåˆ†ç±»å†…å®¹åŒºåŸŸ
                    const untypedContent = document.createElement('div');
                    untypedContent.className = 'device-type-content';
                    
                    // åˆ›å»ºè®¾å¤‡ç½‘æ ¼
                    const deviceGrid = document.createElement('div');
                    deviceGrid.className = 'device-grid';
                    
                    // æ·»åŠ è®¾å¤‡å¡ç‰‡
                    untypedDevices.forEach(device => {
                        const deviceCard = createDeviceCard(device);
                        deviceGrid.appendChild(deviceCard);
                    });
                    
                    // ç»„åˆå…ƒç´ 
                    untypedContent.appendChild(deviceGrid);
                    untypedGroup.appendChild(untypedHeader);
                    untypedGroup.appendChild(untypedContent);
                    deviceList.appendChild(untypedGroup);
                }
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showNotification('è®¾å¤‡åˆ—è¡¨å·²åˆ·æ–°', 'success');
                
            } catch (error) {
                console.error('åˆ·æ–°è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
                showNotification('åˆ·æ–°è®¾å¤‡åˆ—è¡¨å¤±è´¥', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (refreshButton) {
                    refreshButton.innerHTML = '<span class="icon">ğŸ”„</span> åˆ·æ–°';
                    refreshButton.disabled = false;
                }
            }
        }

        // æ§åˆ¶è®¾å¤‡
        function controlDevice(deviceId, action) {
            // å®é™…å®ç°æ—¶ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIå‘è®¾å¤‡å‘é€æ§åˆ¶å‘½ä»¤
            console.log(`å¯¹è®¾å¤‡ ${deviceId} æ‰§è¡Œ ${action} æ“ä½œ`);
            
            // æ¨¡æ‹Ÿæ“ä½œåé¦ˆ
            if (action === 'restart') {
                showNotification(`è®¾å¤‡ ${deviceId} æ­£åœ¨é‡å¯...`, 'info');
            } else if (action === 'reset') {
                showNotification(`è®¾å¤‡ ${deviceId} æ­£åœ¨é‡ç½®...`, 'warning');
            }
        }

        // æ˜¾ç¤ºOTAé€‰é¡¹
        function showOtaOptions(deviceId) {
            // åˆ‡æ¢åˆ°OTAç®¡ç†åŒºåŸŸ
            showSection('ota-management');
            
            // è®¾ç½®ç›®æ ‡è®¾å¤‡
            document.getElementById('target-device').value = deviceId;
            
            // èšç„¦åˆ°æ–‡ä»¶é€‰æ‹©æ¡†
            document.getElementById('firmware-file').focus();
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification(`å·²é€‰æ‹©è®¾å¤‡ ${deviceId} è¿›è¡ŒOTAæ›´æ–°`, 'info');
        }

        // OTAè¡¨å•æäº¤å¤„ç†
        document.getElementById('ota-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const firmwareFile = document.getElementById('firmware-file').files[0];
            const firmwareVersion = document.getElementById('firmware-version').value;
            const otaType = document.querySelector('input[name="ota_type"]:checked').value;
            const targetDevice = document.getElementById('target-device').value;
            const updateDescription = document.getElementById('update-description').value;
            
            if (!firmwareFile) {
                showNotification('è¯·é€‰æ‹©å›ºä»¶æ–‡ä»¶', 'error');
                return;
            }
            
            // è·å–æäº¤æŒ‰é’®å¹¶ä¿®æ”¹ä¸ºåŠ è½½çŠ¶æ€
            const submitButton = this.querySelector('button[type="submit"]');
            const originalContent = submitButton.innerHTML;
            submitButton.innerHTML = '<span class="loading"></span> ä¸Šä¼ ä¸­...';
            submitButton.disabled = true;
            
            // æ„å»ºè¡¨å•æ•°æ®
            const formData = new FormData();
            formData.append('firmware_file', firmwareFile);
            formData.append('firmware_version', firmwareVersion);
            formData.append('ota_type', otaType);
            formData.append('target_device', targetDevice);
            formData.append('update_description', updateDescription);
            
            // å®é™…å®ç°æ—¶ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIä¸Šä¼ å›ºä»¶å¹¶æ‰§è¡ŒOTAæ›´æ–°
            console.log(`ä¸Šä¼ å›ºä»¶ ${firmwareVersion} åˆ° ${targetDevice === 'all' ? 'æ‰€æœ‰åœ¨çº¿è®¾å¤‡' : targetDevice}`);
            
            // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
            setTimeout(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification('OTAæ›´æ–°ä»»åŠ¡å·²åˆ›å»ºï¼Œè®¾å¤‡å°†æ ¹æ®é€‰æ‹©çš„æ›´æ–°æ–¹å¼è¿›è¡Œæ›´æ–°', 'success');
                
                // é‡ç½®è¡¨å•
                this.reset();
            }, 2500);
        });

        // æ–°å»ºè®¾å¤‡è¡¨å•æäº¤å¤„ç†
        document.getElementById('add-device-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const deviceName = document.getElementById('device-name').value;
            const deviceTypeId = document.getElementById('device-type').value;
            const deviceId = document.getElementById('device-id').value;
            const deviceLocation = document.getElementById('device-location').value;
            const deviceDescription = document.getElementById('device-description').value;
            const deviceData = document.getElementById('device-data').value;
            
            // è¡¨å•éªŒè¯
            if (!deviceName) {
                showNotification('è¯·è¾“å…¥è®¾å¤‡åç§°', 'error');
                return;
            }
            
            if (!deviceTypeId) {
                showNotification('è¯·é€‰æ‹©è®¾å¤‡ç±»å‹', 'error');
                return;
            }
            
            if (!deviceId) {
                showNotification('è¯·è¾“å…¥è®¾å¤‡ID', 'error');
                return;
            }
            
            // è·å–æäº¤æŒ‰é’®å¹¶ä¿®æ”¹ä¸ºåŠ è½½çŠ¶æ€
            const submitButton = this.querySelector('button[type="submit"]');
            const originalContent = submitButton.innerHTML;
            submitButton.innerHTML = '<span class="loading"></span> åˆ›å»ºä¸­...';
            submitButton.disabled = true;
            
            try {
                // æ„å»ºè®¾å¤‡æ•°æ®
                const deviceDataObj = {
                    name: deviceName,
                    device_type_id: parseInt(deviceTypeId),
                    device_id: deviceId,
                    location: deviceLocation,
                    description: deviceDescription,
                    private_data: deviceData ? JSON.parse(deviceData) : {}
                };
                
                // è°ƒç”¨APIåˆ›å»ºæ–°è®¾å¤‡
                const response = await fetch('/api/v1/device', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deviceDataObj)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `åˆ›å»ºè®¾å¤‡å¤±è´¥! status: ${response.status}`);
                }
                
                const newDevice = await response.json();
                console.log('åˆ›å»ºæ–°è®¾å¤‡æˆåŠŸ:', newDevice);
                
                // å…³é—­æ¨¡æ€æ¡†
                closeAddDeviceModal();
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification(`è®¾å¤‡ "${deviceName}" å·²æˆåŠŸåˆ›å»º`, 'success');
                
                // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                await refreshDeviceList();
                
            } catch (error) {
                console.error('åˆ›å»ºè®¾å¤‡å¤±è´¥:', error);
                showNotification(error.message || 'åˆ›å»ºè®¾å¤‡å¤±è´¥', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
            }
        });

        // æ˜¾ç¤ºæ ‡ç­¾é¡µ
        function showSection(sectionId) {
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // æ˜¾ç¤ºé€‰å®šéƒ¨åˆ†
            const selectedSection = document.getElementById(sectionId);
            selectedSection.style.display = 'block';
            
            // æ›´æ–°ä¾§è¾¹æ æ´»åŠ¨çŠ¶æ€
            const sidebarLinks = document.querySelectorAll('.sidebar-nav a');
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            // è®¾ç½®å½“å‰é“¾æ¥ä¸ºæ´»åŠ¨çŠ¶æ€
            const activeLink = document.querySelector(`.sidebar-nav a[onclick="showSection('${sectionId}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // å¯¹äºæ–°å»ºè®¾å¤‡éƒ¨åˆ†ï¼Œç›´æ¥æ‰“å¼€æ¨¡æ€æ¡†
            if (sectionId === 'add-device') {
                showAddDeviceModal();
                // è¿”å›åˆ°å½“å‰è®¾å¤‡åˆ—è¡¨
                setTimeout(() => {
                    showSection('current-devices');
                }, 100);
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            `;
            
            // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
            if (type === 'success') {
                notification.style.backgroundColor = '#4caf50';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#f44336';
            } else if (type === 'warning') {
                notification.style.backgroundColor = '#ff9800';
            } else {
                notification.style.backgroundColor = '#2196f3';
            }
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºé€šçŸ¥
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // è‡ªåŠ¨å…³é—­
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
</body>
</html>